<section>
  <h1>Edit letter template</h1>
   <!-- template name input-->
   <div class="mb-3">
    <label for="templateName" class="form-label">Letter template name:</label>
    <input type="text" class="form-control" name="templateName" form="addLetterForm" id="templateName" aria-describedby="emailHelp" value="<%= template.name %>">
  </div>

  <!-- Accordion for all information and iputs -->
  <div class="accordion" id="accordionPanelsStayOpenExample">

    <!-- Receivers stoarge list -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
          Receivers selection
        </button>
      </h2>
      <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
        <div class="accordion-body">

          <!-- top tab with select "select all" button and seacrh input -->
          <div class="all-receivers-top-tab">
            <div class="addLetter-all-receivers-buttons-div">
              <button type="button" class="btn btn-success" onclick="addSelectedToReceiversList()">Add selected to receivers list</button>
            </div>
            <div class="addLetter-all-receivers-buttons-div">
              <button type="button" class="btn btn-secondary" onclick="resetReceiversSelection()">Reset selection</button>
              <button id="selectAllButton" type="button" class="btn btn-primary" onclick="selectAll()">Select all</button>
              <input class="form-control me-2 all-receivers-table-search-input" id="searchInput" type="text" name="searchInput" placeholder="Search">
            </div>
          </div>
          
          <!-- all receivers table  -->
          <table class="table table-primary table-hover addLetter-all-receivers-table">
            <tbody>
              <% const specifiedReceiversIds = template.personalizedLetters.map((personalInfo) => String(personalInfo.receiver._id)) %>
              <% receivers.forEach((receiver) => { %>
                <% if(specifiedReceiversIds.includes(String(receiver._id))){ %>
                  <tr class="receiver all-receivers-table-receiver">
                    <td class="table-primary"><input class="form-check-input" type="checkbox" name="receiverId" value="<%= receiver._id %>,<%= receiver.name %>,<%= receiver.email %>" checked></td> 
                    <td class="table-primary"><%= receiver.name %></td>
                    <td class="table-primary"><%= receiver.email %></td>
                  </tr>
                <% }else{ %>
                  <tr class="receiver all-receivers-table-receiver">
                    <td class="table-primary"><input class="form-check-input" type="checkbox" name="receiverId" value="<%= receiver._id %>,<%= receiver.name %>,<%= receiver.email %>" ></td> 
                    <td class="table-primary"><%= receiver.name %></td>
                    <td class="table-primary"><%= receiver.email %></td>
                  </tr>
                <% } %>
              <% }); %>
            </tbody>
          </table>
          
        </div>
      </div>
    </div>

    <!-- Letter settings -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
          Letter
        </button>
      </h2>
      <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
        <div class="accordion-body">

          <div class="container">
            <div class="row row-cols-2">
              <!-- letter text -->
              <div class="col-8">
                <div class="form-floating">
                  <textarea class="form-control addLetter-textarea" placeholder="Leave a comment here" id="floatingTextarea2" name="rowMessage" style="height: 20rem"><%= template.letterTextRow %></textarea>
                  <label for="floatingTextarea2">Letter text</label>
                </div>
              </div>
              <!-- changeble fields -->
              <div class="col-4">
                <div class="card">
                  <div class="card-header">
                    Changable fields:
                  </div>
                  <ul id="letter-changable-fields-list" class="list-group list-group-flush">
                    <!-- name field by default -->
                    <li class="list-group-item disabled">&ltname&gt</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <input type="hidden" name="changableFieldsList">
          <button type="button" class="btn btn-success" onclick="addLetter(); addChangableFields()">Add letter</button>

        </div>
      </div>
    </div>

    <!-- Selected receivers settings -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-selectedReceivers" aria-expanded="false" aria-controls="panelsStayOpen-selectedReceivers">
          Selected receivers list
        </button>
      </h2>
      <div id="panelsStayOpen-selectedReceivers" class="accordion-collapse collapse">
        <div id="selected-receivers-div" class="accordion-body"></div>
      </div>
    </div>
  
  </div>
</section>


<!-- {
  _id: new ObjectId('6581abfff131b0a5cf9f309a'),
  name: 'ggggg',
  letterTextRow: '<gr>',
  changableFieldsList: [ '<name>', '<gr>' ],
  personalizedLetters: [
    {
      receiver: {
        _id: new ObjectId('656871c86883478103f327ab'),
        name: 'Vladyslav',
        email: 'basher207vd@gmail.com'
      },
      letterText: 'ddd',
      changableFields: [ { fieldName: '<gr>', fieldValue: 'ddd' } ]
    },
    {
      receiver: {
        _id: new ObjectId('6568dac92ad35de30592b301'),
        name: 'bob',
        email: 'hor344@email.com'
      },
      letterText: '&lt;gr&gt;',
      changableFields: [ { fieldName: '<gr>', fieldValue: '' } ]
    }
  ],
  __v: 0
} -->

<script>
// ALL RECEIVERS SECTION
  //searching 
  const searchInput = document.querySelector('.all-receivers-table-search-input');
  searchInput.addEventListener('input', searchFunc);

  function searchFunc() { 
    const filter = searchInput.value.toLowerCase();
    const itemList = document.querySelectorAll('.all-receivers-table-receiver');
    itemList.forEach((item) => {
      const textContent = item.innerText.replace('Add', '').replace('Remove', '');
      if(textContent.toLowerCase().includes(filter)){
        item.style.display = '';
      }else{
        item.style.display = 'none';
      }
    });
  };

  //select all button
  function selectAll() {
    const receiversCheckboxes = document.querySelectorAll('.all-receivers-table-receiver .form-check-input');
    const button = document.querySelector('#selectAllButton');
    if(!button.value){
      button.value = "pressed";
      button.innerText = 'Unselect all';
      button.classList.remove('btn-primary');
      button.classList.add('btn-danger');
      receiversCheckboxes.forEach(checkbox => checkbox.checked = true);
    }else{
      button.value = '';
      button.innerText = 'Select all';
      button.classList.remove('btn-danger');
      button.classList.add('btn-primary');
      receiversCheckboxes.forEach(checkbox => checkbox.checked = false);
    }
  };

  //reset receivers seclection button
  function resetReceiversSelection() {
    const receiversCheckboxes = document.querySelectorAll('.all-receivers-table-receiver .form-check-input');
    const selectAllButton = document.querySelector('#selectAllButton');
    const specifiedReceivers = `<%- JSON.stringify(template.personalizedLetters) %>`;
    const specifiedReceiversIds = JSON.parse(specifiedReceivers).map((personalInfo) => personalInfo.receiver._id);

    //unselecting all by "selectAll" button functionality and changing button values if needed
    selectAllButton.value = "pressed";
    selectAll();
    //checking checkboxes on cpecified emails
    receiversCheckboxes.forEach((checkbox) => {
      const [checkboxReceiverId, _, __] = checkbox.value.split(',');
      if(specifiedReceiversIds.includes(checkboxReceiverId)){
        checkbox.checked = true;
      }
    });
  };


  // LETTER SECTION
  const letterChangablefields = document.querySelector('#letter-changable-fields-list');
  const letterTextInput = document.querySelector('.addLetter-textarea');

  //updating changable fields in letter section when page is loaded first time
  window.onload = () => {
    updateChangableFields();
  };
  
  // adding "Changable fields:" on fly. Select from "letter text" textarea
  letterTextInput.addEventListener('input', () => {
    updateChangableFields();
  });

  function onlyUnique(value, index, array) {
    return array.indexOf(value) === index;
  };

  function updateChangableFields() {
    const text = document.querySelector('.addLetter-textarea').value;
    const allFieldsArr = text.match(/<([^>]+)>/g);
    if(allFieldsArr){
      const fieldsArray = allFieldsArr.filter(onlyUnique);
      if(fieldsArray.includes('<name>')){
        fieldsArray.splice(fieldsArray.indexOf('<name>'), 1);
      }
      if(fieldsArray.length > 0){
        let fieldsInnerHtmlForLetter = '<li class="list-group-item disabled">&ltname&gt</li>';
        const fieldsArrForInnerHtml = fieldsArray.map(el => el.replace(/<|>/g, ''))
        fieldsArrForInnerHtml.forEach((field) => {
          fieldsInnerHtmlForLetter += `<li class="list-group-item">&lt${field}&gt</li>`;
        });
        letterChangablefields.innerHTML = fieldsInnerHtmlForLetter;
      }else{
        letterChangablefields.innerHTML = '<li class="list-group-item disabled">&ltname&gt</li>';
      }
    }else{
      letterChangablefields.innerHTML = '<li class="list-group-item disabled">&ltname&gt</li>';
    }
  };

</script>